# 定期定额长线投资模拟

本程序是对[台湾基金投资教母萧碧燕](https://zh.wikipedia.org/zh-cn/%E8%95%AD%E7%A2%A7%E7%87%95)的相关理论的验证与模拟。定期定额长线投资具有以下特点：

- 停利点越高，交易频率越低，交易周期越长
- 停利点越低，交易频率越高，交易周期越短
- 价格越高，买入单位越少
- 价格越低，买入单位越多

该种方法属于[摊平操作法](https://wiki.mbalib.com/wiki/%E6%91%8A%E5%B9%B3%E6%93%8D%E4%BD%9C%E6%B3%95)中的`逐次平均买进摊平法`，即将要投入金融产品的资金分成N等份，第一次买进全部资产的N分之一，第二次买进N分之一...... 第N次买进N分之一。这种方法不论行情上下都不冒太大的风险。

## 1. 长线投资金律

本程序遵守以下原则对某种`优质`金融产品进行模拟投资，试图寻找该种金融产品是否值得长期投资的建议。

- 坚持扣长期：固定每个月进行固定金额（比如：5000）的投资
- 涨多要停利：涨幅已超过停利目标（比如：20%），要及时卖出获利
- 下跌不停扣：即使扣在相对高点，在下跌段也不停扣
- 逢低再加码：跌幅超过可承受范围时，不停扣且再加码（本程序暂未实现）

## 2. 设计规则

在设计本程序时，主要应用以下规则：

- 步骤1: 在每个月的第一个交易日用固定金额（比如：5000）买入金融产品，而不管它的价格和走势如何
- 步骤2: 当获利幅度达到或超过某个设定值（比如：20%）时，将该产品全部卖出获利
- 步骤3: 继续步骤1

## 3. 数据源

本程序的数据源为[纳斯达克历史数据](https://finance.yahoo.com/quote/%5EIXIC/history?p=%5EIXIC)，以力求最大程度地与现实投资环境相吻合。

## 4. 参数说明

- date: 交易日期
- price: 当日价格
- units: 当前持货单位
- principle: 当前持货本金
- marketValue: 当前持货价值
- currentGainOrLoss: 当前持货损益
- returnRate: 累计回报率
- totalInvestment: 累计投资
- totalGainOrLoss: 累计损益
- previousGainOrLoss: 旧累计损益

## 5. 计算公式

- 买进单位 = 月供投资额 ÷ 当日价格
- 当前持货单位 = 买进单位（如有） + 昨日持货单位；或卖出清零
- 当前持货价值 = 当前持货单位 × 当日价格；或卖出清零
- 当前持货本金 = 距离上次获利卖出后的月数 × 月供投资额；或卖出清零
- 当前持货损益 = 当前持货价值 - 当前持货本金；或卖出清零
- 旧累计损益 = 上次获利卖出时的累计损益
- 累计投资 = 投资月数 × 月供投资额
- 累计损益 = 旧累计损益 + 当前持货损益 = 获利卖出时的持货价值 - 累计投资
- 累计回报率 = 累计损益 ÷ 累计投资

## 6. 计算举例

假设停利点为10%，每月固定投资5000，从2020年1月2日开始投资。

![calculation-example](/docs/calculation-1.png)

2020.01.02：投资第1天（第1个月），买入纳斯达克指数

- 当日价格 = 9092.19043
- 当前持货本金 = 距离上次获利卖出后的月数 × 月供投资额 = 1 * 5000 = 5000
- 当前持货单位 = 月供投资额 ÷ 当日价格 = 5000 ÷ 9092.19043 = 0.5499224899098379
- 当前持货价值 = 当前持货单位 × 当日价格 = 0.5499224899098379 × 9092.19043 = 5000
- 当前持货损益 = 当前持货价值 - 当前持货本金 = 5000 - 5000 = 0
- 旧累计损益 = 上次获利卖出时的累计损益 = 0
- 累计投资 = 投资月数 × 月供投资额 = 1 × 5000 = 5000
- 累计损益 = 旧累计损益 + 当前持货损益 = 0 + 0 = 0
- 累计回报率 = 累计损益 ÷ 累计投资 = 0 ÷ 5000 = 0

2020.01.03：投资第2天（第1个月）

- 当日价格 = 9020.769531
- 当前持货本金 = 距离上次获利卖出后的月数 × 月供投资额 = 1 * 5000 = 5000
- 当前持货单位 = 买进单位（如有） + 昨日持货单位 = 0 + 0.5499224899098379 = 0.5499224899098379
- 当前持货价值 = 当前持货单位 × 当日价格 = 0.5499224899098379 × 9020.769531 = 4960.724041390321
- 当前持货损益 = 当前持货价值 - 当前持货本金 = 4960.724041390321 - 5000 = -39.27595860967904
- 旧累计损益 = 上次获利卖出时的累计损益 = 0
- 累计投资 = 投资月数 × 月供投资额 = 1 × 5000 = 5000
- 累计损益 = 旧累计损益 + 当前持货损益 = 0 - 39.27595860967904 = -39.27595860967904
- 累计回报率 = 累计损益 ÷ 累计投资 = -39.27595860967904 ÷ 5000 = -0.007855191721936

![calculation-example](/docs/calculation-2.png)

2020.02.03: 投资第22天（第2个月），买入纳斯达克指数

- 当日价格 = 9273.400391
- 当前持货本金 = 距离上次获利卖出后的月数 × 月供投资额 = 2 * 5000 = 10000
- 当前持货单位 = 买进单位（如有） + 昨日持货单位 = 5000 ÷ 9273.400391 + 0.5499224899098379 = 1.0890990367192035
- 当前持货价值 = 当前持货单位 × 当日价格 = 1.0890990367192035 × 9273.400391 = 10099.651432949584
- 当前持货损益 = 当前持货价值 - 当前持货本金 = 10099.651432949584 - 10000 = 99.651432949584
- 旧累计损益 = 上次获利卖出时的累计损益 = 0
- 累计投资 = 投资月数 × 月供投资额 = 2 × 5000 = 10000
- 累计损益 = 旧累计损益 + 当前持货损益 = 0 + 99.651432949584 = 99.651432949584
- 累计回报率 = 累计损益 ÷ 累计投资 = 99.651432949584 ÷ 10000 = 0.009965143294958

![calculation-example](/docs/calculation-3.png)

2020.05.29: 投资第103天（第5个月），第一次获利卖出

- 当日价格 = 9489.870117
- 当前持货本金 = 距离上次获利卖出后的月数 × 月供投资额 = 5 * 5000 = 25000（卖出后清零）
- 当前持货单位 = 买进单位（如有） + 昨日持货单位 = 0 + 2.907978016213212 = 2.907978016213212（卖出后清零）
- 当前持货价值 = 当前持货单位 × 当日价格 = 2.907978016213212 × 9489.870117 = 27,596.333676954702059（卖出后清零）
- 当前持货损益 = 当前持货价值 - 当前持货本金 = 27,596.333676954702059 - 25000 = 2,596.333676954702059（卖出后清零）
- 旧累计损益 = 上次获利卖出时的累计损益（本次已卖出） = 2,596.333676954702059
- 累计投资 = 投资月数 × 月供投资额 = 5 × 5000 = 250000
- 累计损益 = 旧累计损益 + 当前持货损益 = 2596.3336769547022 + 0（本次卖出后已清零） = 2596.3336769547022
- 累计回报率 = 累计损益 ÷ 累计投资 = 2596.3336769547022 ÷ 250000 = 0.103853347078188

2020.06.01: 投资第104天（第6个月），买入纳斯达克指数

- 当日价格 = 9552.049805
- 当前持货本金 = 距离上次获利卖出后的月数 × 月供投资额 = 1 * 5000 = 5000
- 当前持货单位 = 买进单位（如有） + 昨日持货单位 = 5000 ÷ 9552.049805 + 0 = 0.5234478569597449
- 当前持货价值 = 当前持货单位 × 当日价格 = 0.5234478569597449 × 9552.049805 = 5000
- 当前持货损益 = 当前持货价值 - 当前持货本金 = 5000 - 5000 = 0
- 旧累计损益 = 上次获利卖出时的累计损益 = 2,596.333676954702059
- 累计投资 = 投资月数 × 月供投资额 = 6 × 5000 = 30000
- 累计损益 = 旧累计损益 + 当前持货损益 = 2,596.333676954702059 + 0 = 2,596.333676954702059
- 累计回报率 = 累计损益 ÷ 累计投资 = 2,596.333676954702059 ÷ 30000 = 0.08654445589849008
